{% extends "base.html" %}
{% block content %}

<!-- Sticky header with lowered z-index (if needed) -->
<style>
  .sticky-top {
    z-index: 900 !important;
  }
  .card-onboarding {
  background-color: #e8f5e9; /* light green */
}
.card-offboarding {
  background-color: #fff3e0; /* light orange */
}
  .card-onboarding .card-body,
  .card-offboarding .card-body {
    background-color: transparent !important;
  }
  .card-onboarding .card-footer,
  .card-offboarding .card-footer {
    background-color: transparent !important;
  }
</style>
<div class="sticky-top bg-light px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
  <h4 class="mb-0">Task Templates</h4>
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTaskModal">
    + New Task
  </button>
</div>

<!-- Search and Filter -->
<div class="container-fluid py-3">
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text">üîç</span>
        <input id="taskSearch" type="text" class="form-control" placeholder="Search tasks...">
      </div>
    </div>
    <div class="col-md-3">
      <select id="phaseFilter" class="form-select">
        <option value="">All Phases</option>
        <option value="onboarding">Onboarding</option>
        <option value="offboarding">Offboarding</option>
      </select>
    </div>
  </div>

<!-- Task Cards -->
<div class="row g-3" id="taskGrid">
  {% for task in tasks %}
  <div class="col-md-6 col-lg-4" data-id="{{ task.id }}" data-phase="{{ task.phase | lower }}">
    <div class="card h-100 shadow-sm border-0 
      {% if task.phase == 'onboarding' %}card-onboarding
      {% elif task.phase == 'offboarding' %}card-offboarding
      {% endif %}">

      <div class="card-body">
        <h5 class="card-title">{{ task.name }}</h5>

        <!-- Badges & View Button -->
        <div class="d-flex flex-wrap align-items-center mb-2 gap-2">
          <span class="badge rounded-pill bg-secondary">Due {{ task.days_before or 0 }} days</span>
          <span class="badge rounded-pill bg-warning text-dark">{{ task.timing }}</span>
          <span class="badge rounded-pill bg-info text-white">{{ task.phase }} date</span>

          <div class="w-100"></div>

          {# ‚Üê New conditional badge #}
          {% if task.is_employee_task %}
            <span class="badge rounded-pill bg-info text-white">Employee Task</span>
          {% else %}
            {% if task.responsible_job_title and task.responsible_job_title.manager %}
              <span class="badge rounded-pill bg-success text-white">
                Responsible: {{ task.responsible_job_title.manager.username }}
              </span>
            {% else %}
              <span class="badge rounded-pill bg-secondary">‚Äî</span>
            {% endif %}
          {% endif %}

          <div class="w-100"></div>

          <button class="view-assigned-btn btn btn-sm btn-outline-info d-flex align-items-center"
                  data-assigned="{{ task.assigned_job_titles | map(attribute='title') | join(',') }}">
            <i class="bi bi-eye-fill me-1"></i> View Job Titles
          </button>
        </div>

        <p class="card-text text-muted"
           data-bs-toggle="popover"
           data-bs-trigger="hover focus"
           data-bs-content="{{ task.description }}">
          {{ task.description|truncate(60) }}
        </p>
      </div>

      <div class="card-footer text-end">
        <button class="btn btn-sm btn-outline-primary edit-btn me-1"
        data-bs-toggle="modal"
        data-bs-target="#editTaskModal"
        data-id="{{ task.id }}"
        data-name="{{ task.name }}"
        data-phase="{{ task.phase }}"
        data-timing="{{ task.timing }}"
        data-daysbefore="{{ task.days_before }}"
        data-responsibletitle="{{ task.responsible_job_title_id }}"
        data-email="{{ task.responsible_email or '' }}"
        data-jobtitles="{{ task.assigned_job_titles | map(attribute='id') | join(',') }}"
        data-description="{{ task.description }}"
        data-is-employee-task="{{ 1 if task.is_employee_task else 0 }}"
        data-document-type="{{ task.document_type_id or '' }}">
        ‚úé
      </button>

        <button class="btn btn-sm btn-outline-danger delete-btn">üóë</button>
      </div>

    </div>
  </div>
  {% endfor %}
</div>


<!-- Create Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form id="addForm" class="modal-content" method="POST" action="{{ url_for('hr.manage_hr_tasks') }}">
      <div class="modal-header">
        <h5 class="modal-title">Add New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body row g-3">
        <!-- Task Name -->
        <div class="col-md-6">
          <label class="form-label">Task Name</label>
          <input type="text" class="form-control" id="createName" name="name" required>
        </div>

        <!-- Phase -->
        <div class="col-md-6">
          <label class="form-label">Phase</label>
          <select class="form-select" id="createPhase" name="phase" required>
            <option value="onboarding">Onboarding</option>
            <option value="offboarding">Offboarding</option>
          </select>
        </div>

        <!-- Employee‚ÄêTask Checkbox -->
        <div class="col-12 form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="createIsEmployeeTask"
            name="is_employee_task"
            value="on"
          >
          <label class="form-check-label" for="createIsEmployeeTask">
            Assign directly to employee
          </label>
        </div>

        <!-- Document Type (optional) -->
        <div class="col-md-6">
          <label class="form-label">Document Type (optional)</label>
          <select id="createDocumentType" name="document_type_id" class="form-select">
            <option value="">‚Äî none ‚Äî</option>
            {% for dt in document_types %}
              <option value="{{ dt.id }}">{{ dt.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Responsible Job Title -->
        <div class="col-md-6 manager-fields">
          <label class="form-label">Responsible Job Title</label>
          <select id="createResponsibleJobTitle" class="form-select" name="responsible_job_title_id">
            <option value="">Select</option>
            {% for jt in job_titles %}
              <option value="{{ jt.id }}" data-email="{{ jt.manager.email if jt.manager else '' }}">
                {{ jt.title }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Manager Email -->
        <div class="col-md-6 manager-fields">
          <label class="form-label">Manager Email</label>
          <input type="email" class="form-control" id="createEmail" name="responsible_email">
        </div>

        <!-- Assign to Job Titles -->
        <div class="col-md-12">
          <label class="form-label">Assign to Job Titles</label>
          <select id="createJobTitles" class="form-select" name="assigned_job_title_ids" multiple required>
            {% for jt in job_titles %}
              <option value="{{ jt.id }}">{{ jt.title }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Due Offset -->
        <div class="col-md-6">
          <label class="form-label">Due Offset (Days)</label>
          <input type="number" class="form-control" id="createDaysBefore" name="days_before">
        </div>

        <!-- Timing -->
        <div class="col-md-6">
          <label class="form-label">Timing</label>
          <select id="createTiming" class="form-select" name="timing">
            <option value="before">Before</option>
            <option value="after">After</option>
          </select>
        </div>

        <!-- Description -->
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea class="form-control" id="createDescription" name="description" rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Create Task</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>


<!-- Edit Task Modal (same structure as add, but prefilled via JS) -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form id="editForm" class="modal-content" method="POST">
      <div class="modal-header">
        <h5 class="modal-title">Edit Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <input type="hidden" id="editTaskId" name="id">
        <div class="col-md-6">
          <label class="form-label">Task Name</label>
          <input type="text" class="form-control" id="editName" name="name" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Phase</label>
          <select class="form-select" id="editPhase" name="phase" required>
            <option value="onboarding">Onboarding</option>
            <option value="offboarding">Offboarding</option>
          </select>
        </div>
        <!-- NEW: employee‚Äêtask checkbox -->
        <div class="col-12 form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="editIsEmployeeTask"
            name="is_employee_task"
            value="on"
          >
          <label class="form-check-label" for="editIsEmployeeTask">
            Assign directly to employee
          </label>
        </div>
        
        <!-- Document Type (optional) -->
        <div class="col-md-6">
          <label class="form-label">Document Type (optional)</label>
          <select id="editDocumentType" name="document_type_id" class="form-select">
            <option value="">‚Äî none ‚Äî</option>
            {% for dt in document_types %}
              <option value="{{ dt.id }}">{{ dt.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- RESPONSIBLE JOB TITLE (wrap in manager-fields) -->
        <div class="col-md-6 manager-fields">
          <label class="form-label">Responsible Job Title</label>
          <select id="editResponsibleJobTitle" class="form-select" name="responsible_job_title_id">
            <option value="">Select</option>
            {% for jt in job_titles %}
              <option value="{{ jt.id }}" data-email="{{ jt.manager.email if jt.manager else '' }}">
                {{ jt.title }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- MANAGER EMAIL (also manager-fields) -->
        <div class="col-md-6 manager-fields">
          <label class="form-label">Manager Email</label>
          <input type="email" class="form-control" id="editEmail" name="responsible_email">
        </div>
        <div class="col-md-12">
          <label class="form-label">Assign to Job Titles</label>
          <select id="editJobTitles" class="form-select" name="assigned_job_title_ids" multiple required>
            {% for jt in job_titles %}
              <option value="{{ jt.id }}">{{ jt.title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Due Offset (Days)</label>
          <input type="number" class="form-control" id="editDaysBefore" name="days_before">
        </div>
        <div class="col-md-6">
          <label class="form-label">Timing</label>
          <select id="editTiming" class="form-select" name="timing">
            <option value="before">Before</option>
            <option value="after">After</option>
          </select>
        </div>
      <!-- Description textarea -->
      <div class="col-12">
        <label class="form-label">Description</label>
        <textarea class="form-control" id="editDescription" name="description"></textarea>
      </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
<div class="modal fade" id="viewAssignedModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assigned Job Titles</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul id="assignedList" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Initialize Bootstrap popovers
    document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => {
      new bootstrap.Popover(el);
    });
  
    // 2. Auto‚Äêfill manager email (Create modal)
    document.getElementById('createResponsibleJobTitle')?.addEventListener('change', function() {
      document.getElementById('createEmail').value = this.selectedOptions[0]?.dataset.email || '';
    });
  
    // 3. Auto‚Äêfill manager email (Edit modal)
    document.getElementById('editResponsibleJobTitle')?.addEventListener('change', function() {
      document.getElementById('editEmail').value = this.selectedOptions[0]?.dataset.email || '';
    });
  
    // 4. Toggle manager‚Äêfields when "Assign directly to employee" is checked
    [
      { modalId: 'addTaskModal',    checkboxId: 'createIsEmployeeTask' },
      { modalId: 'editTaskModal',   checkboxId: 'editIsEmployeeTask'   }
    ].forEach(({ modalId, checkboxId }) => {
      const modalEl  = document.getElementById(modalId);
      const checkbox = document.getElementById(checkboxId);
      if (!modalEl || !checkbox) return;
  
      const mgrFields = Array.from(modalEl.querySelectorAll('.manager-fields'));
      const toggleMgr = () => {
        const hide = checkbox.checked;
        mgrFields.forEach(div => {
          div.style.display = hide ? 'none' : '';
          div.querySelectorAll('input, select').forEach(el => el.required = !hide);
        });
      };
  
      checkbox.addEventListener('change', toggleMgr);
      modalEl.addEventListener('show.bs.modal', toggleMgr);
    });
  
    // 5. Handle Delete / Edit / View-Assigned buttons
    const grid = document.getElementById('taskGrid');
    grid?.addEventListener('click', e => {
      const target = e.target;
  
      // Delete
      if (target.matches('.delete-btn')) {
        const col    = target.closest('[data-id]');
        const taskId = col?.dataset.id;
        if (taskId && confirm('Delete this task?')) {
          fetch(`/delete_hr_task/${taskId}`, { method: 'POST' })
            .then(res => res.ok ? col.remove() : alert('Error deleting task.'));
        }
      }
  
      // Edit
      if (target.matches('.edit-btn')) {
        const btn     = target;
        const modalEl = document.getElementById('editTaskModal');
        if (!modalEl) return;
        const mf = sel => modalEl.querySelector(sel);

        // Basic fields
        mf('#editTaskId').value                 = btn.dataset.id;
        mf('#editName').value                   = btn.dataset.name;
        mf('#editPhase').value                  = btn.dataset.phase;
        mf('#editTiming').value                 = btn.dataset.timing;
        mf('#editDaysBefore').value             = btn.dataset.daysbefore;
        mf('#editResponsibleJobTitle').value    = btn.dataset.responsibletitle;
        mf('#editEmail').value                  = btn.dataset.email;
        mf('#editDescription').value            = btn.dataset.description;

        // Employee‚Äêtask checkbox
        mf('#editIsEmployeeTask').checked       = btn.dataset.isEmployeeTask === '1';

        // Assigned job titles
        const ids = (btn.dataset.jobtitles || '').split(',');
        Array.from(mf('#editJobTitles').options).forEach(opt => {
          opt.selected = ids.includes(opt.value);
        });

        // Document‚Äêtype dropdown
        const docSel = mf('#editDocumentType');
        if (docSel) {
          // blank or real id
          docSel.value = btn.dataset.documentType || '';
        }

        // Finally show
        new bootstrap.Modal(modalEl).show();
      }
  
      // View Assigned Job Titles
      if (target.matches('.view-assigned-btn')) {
        const titles = (target.dataset.assigned || '').split(',');
        const ul     = document.getElementById('assignedList');
        if (!ul) return;
        ul.innerHTML = '';
        titles.forEach(t => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = t;
          ul.appendChild(li);
        });
        new bootstrap.Modal(document.getElementById('viewAssignedModal')).show();
      }
    });
  
    // 6. Submit Edit Form via AJAX
    document.getElementById('editForm')?.addEventListener('submit', e => {
      e.preventDefault();
      const taskId = document.getElementById('editTaskId').value;
      const payload = {
        name:                   document.getElementById('editName').value,
        phase:                  document.getElementById('editPhase').value,
        timing:                 document.getElementById('editTiming').value,
        days_before:            parseInt(document.getElementById('editDaysBefore').value, 10) || 0,
        responsible_email:      document.getElementById('editEmail').value,
        responsible_job_title_id: document.getElementById('editResponsibleJobTitle').value,
        assigned_job_title_ids: Array.from(document.getElementById('editJobTitles').selectedOptions).map(o => o.value),
        description:            document.getElementById('editDescription').value
      };
      fetch(`/update_hr_task/${taskId}`, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify(payload)
      }).then(res => {
        if (res.ok) window.location.reload();
        else alert('Failed to update task.');
      });
    });
  
    // 7. Live Search
    document.getElementById('taskSearch')?.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      document.querySelectorAll('#taskGrid [data-id]').forEach(col => {
        const card   = col.querySelector('.card');
        const title  = card?.querySelector('.card-title')?.textContent.toLowerCase() || '';
        col.classList.toggle('d-none', !title.includes(q));
      });
    });
  
    // 8. Phase Filter
    document.getElementById('phaseFilter')?.addEventListener('change', function() {
      const sel = this.value.toLowerCase();
      document.querySelectorAll('#taskGrid [data-phase]').forEach(col => {
        col.classList.toggle('d-none', sel && col.dataset.phase !== sel);
      });
    });
  
    // 9. Cleanup backdrop after closing Edit modal
    document.getElementById('editTaskModal')?.addEventListener('hidden.bs.modal', () => {
      document.body.classList.remove('modal-open');
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    });
  });

  
  </script>
  
  
{% endblock %}
