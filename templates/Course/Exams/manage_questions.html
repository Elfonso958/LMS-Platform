{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h1>Manage Questions for {{ course.title }}</h1>

  <!-- Add Question (now just another openModal button) -->
  <button class="btn btn-primary mb-4 openModal"
          data-url="{{ url_for('course.manage_questions', course_id=course.id) }}?modal=add"
          data-title="Add New Question">
    <i class="bi bi-plus-circle"></i> Add New Question
  </button>

  <hr>

  <h2>Existing Questions</h2>
  <ul class="list-group">
    {% for question in questions %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ question.text }}
        <div style="display:flex; gap:8px;">
          <button class="btn btn-secondary btn-sm openModal"
                  data-url="{{ url_for('course.manage_questions', course_id=course.id) }}?modal=edit&question_id={{ question.id }}"
                  data-title="Edit Question">
            Edit
          </button>
          <button class="btn btn-primary btn-sm openModal"
                  data-url="{{ url_for('course.manage_questions', course_id=course.id) }}?modal=answers&question_id={{ question.id }}"
                  data-title="Manage Answers">
            Manage Answers
          </button>
          <button class="btn btn-danger btn-sm openConfirm"
                  data-url="{{ url_for('course.delete_question', question_id=question.id) }}">
            Delete
          </button>
        </div>
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Generic Bootstrap Modal -->
<div class="modal fade" id="genericModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Loadingâ€¦</h5>
        <button type="button" class="btn-close"
                data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center py-5">
          <div class="spinner-border" role="status"></div>
        </div>
      </div>
    </div>
  </div>
</div>

{% raw %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modalEl    = document.getElementById('genericModal');
  const modal      = new bootstrap.Modal(modalEl);
  const titleEl    = modalEl.querySelector('.modal-title');
  const bodyEl     = modalEl.querySelector('.modal-body');

  function openModal(url, title = '') {
    titleEl.textContent = title;
    bodyEl.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border" role="status"></div>
      </div>`;
    modal.show();

    fetch(url)
      .then(res => res.text())
      .then(html => {
        bodyEl.innerHTML = html;
        bindModalForm();
        bindAddAnswer();
      });
  }

  function bindModalForm() {
    const form = bodyEl.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', e => {
      e.preventDefault();
      const data = new FormData(form);
      fetch(form.action, {
        method: form.method,
        body: data
      })
      .then(res => res.redirected 
        ? window.location.reload() 
        : res.text()
      )
      .then(html => {
        if (html) {
          bodyEl.innerHTML = html;
          bindModalForm();
          bindAddAnswer();
        }
      });
    }, { once: true });
  }

  function bindAddAnswer() {
    const btn       = bodyEl.querySelector('.openAddAnswerBtn');
    const tpl       = bodyEl.querySelector('#newAnswerTemplate')?.content;
    const container = bodyEl.querySelector('#newAnswersContainer');

    if (btn && tpl && container) {
      btn.onclick = () => {
        const clone = document.importNode(tpl, true);
        container.appendChild(clone);
      };
    }
  }

  // Delegate all openModal & openConfirm clicks
  document.body.addEventListener('click', e => {
    // openModal
    const op = e.target.closest('.openModal');
    if (op) {
      e.preventDefault();
      openModal(op.dataset.url, op.dataset.title);
      return;
    }
    // openConfirm
    const cf = e.target.closest('.openConfirm');
    if (cf) {
      e.preventDefault();
      if (confirm('Are you sure?')) {
        fetch(cf.dataset.url, { method: 'POST' })
          .then(() => window.location.reload());
      }
    }
  });
});
</script>
{% endraw %}
{% endblock %}
