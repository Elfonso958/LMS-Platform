{# templates/documents/upload_document.html #}
{% extends "base.html" %}
{% block title %}Upload Document{% endblock %}
{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Upload Document for Review</h2>
  <form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <div class="mb-3">
      {{ form.document_type.label(class="form-label") }}
      {{ form.document_type(class="form-select", id="docTypeSelect") }}
    </div>

    <div class="mb-3">
      {{ form.document_expiry_date.label(class="form-label") }}
      {{ form.document_expiry_date(class="form-control") }}
    </div>

    <div id="fileInputsContainer">
      {# initial fallback; JS will replace these on load #}
      {% for i in range(pages_required) %}
      <div class="mb-3">
        <label for="file_{{i+1}}" class="form-label">
          Page {{ i+1 }} of {{ pages_required }}
        </label>
        <input type="file" class="form-control" id="file_{{i+1}}" name="files[]" required>
      </div>
      {% endfor %}
    </div>

    <button type="submit" class="btn btn-primary">Submit for Review</button>
    <a href="{{ url_for('user.user_dashboard') }}" class="btn btn-secondary ms-2">Cancel</a>
  </form>
</div>

<script>
// build a map from your passed-in doc_types
const pagesMap = {
  {% for dt in doc_types %}
    "{{ dt.id }}": {{ dt.pages_required or 1 }}{% if not loop.last %},{% endif %}
  {% endfor %}
};

function renderFileInputs(count) {
  const container = document.getElementById('fileInputsContainer');
  container.innerHTML = '';
  for (let i = 1; i <= count; i++) {
    const div = document.createElement('div');
    div.className = 'mb-3';
    div.innerHTML = `
      <label for="file_${i}" class="form-label">
        Page ${i} of ${count}
      </label>
      <input
        type="file"
        class="form-control"
        id="file_${i}"
        name="files[]"
        required
      >
    `;
    container.appendChild(div);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('docTypeSelect');
  // 1) initial render
  const initialCount = pagesMap[select.value] || 1;
  renderFileInputs(initialCount);
  // 2) re-render on change
  select.addEventListener('change', () => {
    const cnt = pagesMap[select.value] || 1;
    renderFileInputs(cnt);
  });
});
</script>
{% endblock %}
