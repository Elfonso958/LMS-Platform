{% extends "base.html" %}
{% block title %}All Approved User Documents{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Sidebar User List -->
    <div class="col-md-3 border-end" style="height: 80vh; overflow-y: auto;">
      <h5>Users</h5>
      <ul class="list-group">
        {% for uid, data in grouped_docs.items() %}
          <a class="list-group-item list-group-item-action" href="?selected={{ uid }}">{{ data.user.username }}</a>
        {% endfor %}
      </ul>
    </div>

    <!-- Main Document Panel -->
    <div class="col-md-9" style="height: 80vh; overflow-y: auto;">
      {% if selected_id in grouped_docs %}
        {% set data = grouped_docs[selected_id] %}
        <div id="user{{ selected_id }}" class="mb-5">
          <h4>{{ data.user.username }}</h4>

          <!-- ‚úÖ Inline Upload Form -->
          <form method="POST" action="{{ url_for('document.upload_document_admin') }}" enctype="multipart/form-data" class="mb-3 border p-3 bg-light rounded">
            <input type="hidden" name="user_id" value="{{ data.user.id }}">
            <div class="row g-2">
              <div class="col-md-4">
                <select name="document_type_id" class="form-select" required>
                  <option value="" disabled selected>Document Type</option>
                  {% for dt in document_types %}
                    <option value="{{ dt.id }}">{{ dt.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <input type="date" name="document_expiry_date" class="form-control" required>
              </div>
              <div class="col-md-3">
                <input type="file" name="file" class="form-control" required>
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-success w-100">Upload</button>
              </div>
            </div>
          </form>

          {% if data.documents %}
            <ul class="list-group">
              {% for doc_type, docs in data.documents.items() %}
                <li class="list-group-item">
                  <strong>üìÅ {{ doc_type }}</strong>
                  <ul class="list-unstyled ms-4 mt-2">
                    {% for doc in docs %}
                      <li class="mb-2">
                        üìÑ <button 
                        type="button"
                        class="btn btn-link p-0"
                        data-bs-toggle="modal"
                        data-bs-target="#docModal"
                        data-doc="{{ url_for('static', filename=doc.file_path) }}">
                        {{ doc.type.name }} - {{ doc.document_expiry_date.strftime('%Y-%m-%d') }}
                      </button>

                      </li>
                    {% endfor %}
                  </ul>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No approved documents.</p>
          {% endif %}
        </div>
      {% endif %}
      <!-- Modal -->
<div class="modal fade" id="docModal" tabindex="-1" aria-labelledby="docModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="docModalLabel">Document Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="docImage" src="" class="img-fluid w-100" style="max-height: 80vh; object-fit: contain;" />
      </div>
    </div>
  </div>
</div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const docModal = document.getElementById('docModal');
    const img = document.getElementById('docImage');
  
    docModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const docUrl = button.getAttribute('data-doc');
      img.src = docUrl;
    });
  
    docModal.addEventListener('hidden.bs.modal', function () {
      img.src = ""; // Clear image when modal closes
    });
  });
  </script>
  
  
{% endblock %}
